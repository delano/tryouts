#!/usr/bin/ruby

#
# Tryouts - Don't waste your time writing tests
#
# Usage:
#
#      $ try
#      $ try -q
#      $ try -v
#      $ try path/2/file.rb
#      $ try -q path/2/file.rb path/2/another.rb
#
pp RUBY_VERSION
require 'pathname'

# Put our local lib in first place
BASE_PATH = Pathname.new(__dir__).join('..')
lib_dir = BASE_PATH.join('lib')
$LOAD_PATH.unshift lib_dir.to_s

require 'tryouts'

# Help out the requires in the tryouts
[File.join(Dir.pwd, 'lib'), File.join(Dir.pwd, '..', 'lib')].each do |dir|
  p [:loading, dir]
  $LOAD_PATH.unshift dir
end

unless ARGV.delete('-V').nil?
  puts "Tryouts: #{Tryouts::VERSION}"
  exit
end

Tryouts.quiet = !ARGV.delete('-q').nil?  # eg try -q [PATH]
Tryouts.noisy = !ARGV.delete('-v').nil?  # eg try -v [PATH]

if ARGV.empty?
  paths = Dir.glob(File.join(Dir.pwd, '{try,tryouts}', '*_{try,tryouts}.rb'))
  paths += Dir.glob(File.join(Dir.pwd, '*_{try,tryouts}.rb'))
else
  paths = ARGV
end

language_path = BASE_PATH.join('tree-sitter-grammar/build/Release/tree_sitter_ruby_tryouts.dylib')

parser = Tryouts::Parser.new(language_path)
test_file = parser.parse_file(BASE_PATH.join('try/step1_try.rb'))

puts "File: #{test_file.path}"
test_file.test_cases.each do |test|
  puts "\nTest: #{test.title}"
  puts "Code:\n#{test.code}"
  puts "Expectations:"
  test.expectations.each { |exp| puts "- #{exp}" }
  puts "-" * 40
end
